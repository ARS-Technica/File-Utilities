"""
A simple script to download every available issue of a single manga series hosted on https://w15.mangafreak.net. 
"""


import os
import requests
from bs4 import BeautifulSoup
import re
from tqdm import tqdm  # Import tqdm for the progress bar
import tkinter as tk  # Import tkinter for the GUI

def get_manga_title(url):
    manga_title = url.split('/')[-1]
    manga_title = manga_title.replace("_", " ")
    return manga_title

def download_files(url, folder_path, progress_bar):
    response = requests.get(url)
    soup = BeautifulSoup(response.text, 'html.parser')
    download_links = soup.find_all('a', text=re.compile(r'Download', re.IGNORECASE))

    for link in download_links:
        file_url = link['href']
        file_name = file_url.split('/')[-1]
        file_name = file_name.replace("_", " ")

        if file_name.endswith('.zip'):
            file_name = file_name.replace('.zip', '.cbz')
        elif file_name.endswith('.rar'):
            file_name = file_name.replace('.rar', '.cbr')

        with open(os.path.join(folder_path, file_name), 'wb') as file:
            file_response = requests.get(file_url, stream=True)
            total_size = int(file_response.headers.get('content-length', 0))
            block_size = 1024  # 1 KB

            with tqdm(total=total_size, unit='B', unit_scale=True, desc=file_name) as pbar:
                for data in file_response.iter_content(block_size):
                    pbar.update(len(data))
                    file.write(data)
        progress_bar.update(1)  # Increment the overall progress bar

def main():
    url = input("Enter the URL: ")

    if not url.startswith("https://w15.mangafreak.net"):
        print("Invalid URL. Please provide a valid MangaFreak URL.")
        return

    manga_title = get_manga_title(url)
    folder_path = manga_title.replace(" ", "_")
    os.makedirs(folder_path, exist_ok=True)

    # Initialize GUI
    root = tk.Tk()
    root.title("Manga Scraper Progress")

    # Create a progress bar for the overall progress
    overall_progress = tk.DoubleVar()
    overall_progress.set(0)

    overall_progress_bar = tk.Progressbar(root, variable=overall_progress, maximum=100)
    overall_progress_bar.pack(pady=10)

    # Download files and update the progress bar
    download_files(url, folder_path, overall_progress_bar)

    # Close the GUI and display a completion message
    root.destroy()
    print("Manga Downloaded Successfully!")

if __name__ == "__main__":
    main()



